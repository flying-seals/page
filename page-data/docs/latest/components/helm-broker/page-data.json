{"componentChunkName":"component---src-views-docs-index-tsx","path":"/docs/latest/components/helm-broker","webpackCompilationHash":"aefb7e842b40c338951f","result":{"pageContext":{"isCreatedByStatefulCreatePages":false,"version":"latest","versions":{"releases":["0.9"],"prereleases":["1.0"],"branches":["master"]},"content":{"id":"helm-broker","displayName":"Helm Broker","description":"Overall documentation for the Helm Broker","type":"components","docs":[{"order":"01-01-helm-broker","title":"Overview","source":"\nThe Helm Broker is a [Service Broker](/docs/latest/components/service-catalog/#service-brokers-overview) which exposes Helm charts as Service Classes in the Service Catalog. To do so, the Helm Broker uses the concept of bundles. Bundles are abstraction layers over Helm charts which provide all necessary information to convert the charts into Service Classes.\n\nThe Helm Broker fetches bundles which contain a set of specific [files](#details-create-a-bundle). You must place your bundles in a repository of an appropriate [format](#details-create-a-bundles-repository). By default, the Helm Broker fetches bundles from the release of the [`bundles`](https://github.com/kyma-project/bundles/releases) repository. You can also [configure](#configuration-configuration) the Helm Broker to fetch bundle definitions from any remote HTTP server.\n\nIn Kyma, you can use bundles to install the following Service Brokers:\n\n* [Google Cloud Platform (GCP) Broker](/docs/latest/components/service-catalog/#service-brokers-gcp-broker)\n* [Azure Service Broker](/docs/latest/components/service-catalog/#service-brokers-azure-service-broker)\n\nTo get all the bundles that the Helm Broker provides, go to the [`bundles`](https://github.com/kyma-project/bundles) repository.\n\nThe Helm Broker implements the [Open Service Broker API](https://github.com/openservicebrokerapi/servicebroker/blob/v2.14/profile.md#service-metadata) (OSB API).\nTo be compliant with the Service Catalog version used in Kyma, the Helm Broker supports only the following OSB API versions:\n- v2.13\n- v2.12\n- v2.11\n\n> **NOTE:** The Helm Broker does not implement the OSB API update operation.\n"},{"order":"02-01-helm-broker","title":"Architecture","source":"\nThe Helm Broker workflow starts with the registration process, during which the Helm Broker fetches bundles from the Kyma [`bundles`](https://github.com/kyma-project/bundles) repository, or from a remote HTTPS server.\n\n### Registration process\n\nThe registration process consists of the following steps:\n1. The Helm Broker fetches bundles.\n2. The Helm Broker registers bundles as Service Classes in the Service Catalog.\n\n![Helm Broker registration](./assets/hb-registration.svg)\n\n### Bundles provisioning and binding\n\nAfter the registration, you can provision and bind your bundles. Follow these steps:\n\n1. Select a given bundle Service Class from the Service Catalog.\n2. Provision this Service Class by creating its ServiceInstance in a given Namespace.\n3. Bind your ServiceInstance to a service or lambda.\n4. The service or lambda calls a given bundle.\n\n![Helm Broker architecture](./assets/hb-architecture.svg)\n"},{"order":"03-01-create-bundles","title":"Create a bundle","source":"\nBundles which the Helm Broker uses must have a specific structure. These are all possible files that you can include in your bundle:\n\n```\nsample-bundle/\n  ├── meta.yaml                             # [REQUIRED] A file which contains metadata information about this bundle\n  ├── chart/                                # [REQUIRED] A directory which contains a Helm chart that installs your Kubernetes resources\n  │    └── {chart-name}/                    # [REQUIRED] A Helm chart directory\n  │         └── ....                        # [REQUIRED] Helm chart files   \n  └── plans/                                # [REQUIRED] A directory which contains the possible plans for an installed chart\n       ├── example-enterprise               # [REQUIRED] A directory which contains files for a specific plan\n       │   ├── meta.yaml                    # [REQUIRED] A file which contains metadata information about this plan\n       │   ├── bind.yaml                    # A file which contains information required to bind this plan\n       │   ├── create-instance-schema.json  # JSON schema definitions for creating a ServiceInstance\n       │   ├── bind-instance-schema.json    # JSON schema definitions for binding a ServiceInstance\n       │   ├── update-instance-schema.json  # JSON schema definitions for updating a ServiceInstance\n       │   └── values.yaml                  # Default configuration values in this plan for a chart defined in the `chart` directory\n       └── ....\n```\n\n> **NOTE:** All file names in a bundle repository are case-sensitive.\n\nFor details about particular files, read the following sections.\n\n## meta.yaml file\n\nThe `meta.yaml` file contains information about the bundle. Define the following fields to create a service object which complies with the [Open Service Broker API](https://github.com/openservicebrokerapi/servicebroker/blob/v2.14/spec.md#service-object).\n\n|      Field Name     | Required |                   Description             |\n|-------------------|:--------:|----------------------------------------------|\n|         **name**        |   YES   | The name of the bundle.  |\n|       **version**       |   YES   | The version of the bundle. It is a broker service identifier.  |\n|          **id**         |   YES   | The broker service identifier.  |\n|     **description**     |   YES   | The short description of the service. |\n|     **displayName**     |   YES   | The display name of the bundle.    |\n|         **tags**        |   NO  | Keywords describing the provided service, separated by commas.     |\n|       **bindable**      |   NO  | The field that specifies whether you can bind a given bundle. |\n| **providerDisplayName** |   NO  | The name of the upstream entity providing the actual service.  |\n|   **longDescription**   |   NO  | The long description of the service.     |\n|   **documentationURL**  |   NO  | The link to the documentation page for the service.        |\n|      **supportURL**     |   NO  | The link to the support page for the service.     |\n|       **imageURL**      |   NO  | The URL to an image. You must provide the image in the `SVG` format.          |\n|       **labels**        |   NO  | Key-value pairs that help you to organize your project. Use labels to indicate different elements, such as Namespaces, services, or teams.   |\n| **bindingsRetrievable** |   NO  | The field that specifies whether fetching a ServiceBinding using a GET request on the resource's endpoint is supported for all plans. The default value is `false`.   |\n|   **planUpdatable**     |   NO  |  The field that specifies whether instances of this service can be updated to a different plan. The default value is `false`  |\n|       **requires**      |   NO  | The list of permissions the user must grant to the instances of this service. |\n| **provisionOnlyOnce**   |   NO  | The field that specifies whether the bundle can be provisioned only once in a given Namespace. The default value is `false`. |\n\n> **NOTE**: The **provisionOnlyOnce** and **local** keys are reserved and cannot be added to the **labels** entry, since the Helm Broker overrides them at runtime. The Helm Broker always adds the `local:true` label and it adds the `provisionOnlyOnce:true` label only if **provisionOnlyOnce** is set to `true`.\n\n## chart directory\n\nIn the `chart` directory, create a folder with the same name as your chart. Put all the files related to your chart in this folder. The system supports Helm version 2.6.\n\n> **NOTE:** The Helm Broker uses the [helm wait](https://github.com/kubernetes/helm/blob/release-2.6/docs/using_helm.md#helpful-options-for-installupgraderollback) option to ensure that all the resources that a chart creates are available. If you set your Deployment **replicas** to `1`, you must set **maxUnavailable** to `0` as a part of the rolling update strategy.\n\n## plans directory\n\nThe `plans` directory must contain at least one plan. Each plan must contain the `meta.yaml` file. Other files are not mandatory.\n\n* `meta.yaml` file - contains information about a given plan. Define the following fields to create a plan object which complies with the [Open Service Broker API](https://github.com/openservicebrokerapi/servicebroker/blob/v2.14/spec.md#plan-object).\n\n|  Field Name | Required |      Description               |\n|-----------|:--------:|------------------------------------|\n|     **name**    |   YES   |     The name of the plan.   |\n|      **id**     |   YES   |     The ID of the plan. |\n| **description** |   YES   | The description of the plan. |\n| **displayName** |   YES   | The display name of the plan. |\n|  **bindable**   |   NO  | The field that specifies whether you can bind an instance of the plan or not. The default value is `false`. |\n|     **free**    |   NO  | The attribute which specifies whether an instance of the plan is free or not. The default value is `false`.    |\n\n* `bind.yaml` file - contains information about binding in a specific plan. If you define in the `meta.yaml` file that your plan is bindable, you must also create a `bind.yaml` file. For more information about this file, see [this](#details-bind-bundles) document.\n\n* `values.yaml` file - provides the default configuration values in a given plan for the chart definition located in the `chart` directory. For more information, see the [values files](https://github.com/kubernetes/helm/blob/release-2.6/docs/chart_template_guide/values_files.md) specification.\n\n* `create-instance-schema.json` file - contains a schema that defines parameters for a provision operation of a ServiceInstance. Each input parameter is expressed as a property within a JSON object.\n\n* `update-instance-schema.json` file - contains a schema that defines parameters for an update operation of a ServiceInstance. Each input parameter is expressed as a property within a JSON object.\n\n* `bind-instance-schema.json` file - contains a schema that defines parameters for a bind operation. Each input parameter is expressed as a property within a JSON object.\n\n>**NOTE:** For more information about schemas, see [this](https://github.com/openservicebrokerapi/servicebroker/blob/master/spec.md#schemas-object) specification.\n\n## Troubleshooting\n\nUse the dry run mode to check the generated manifests of the chart without installing it.\nThe `--debug` option prints the generated manifests.\nAs a prerequisite, you must install [Helm](https://github.com/kubernetes/helm) on your machine to run this command:\n\n```\n helm install --dry-run {path-to-chart} --debug\n```\nFor more details, read the Helm [official documentation](https://docs.helm.sh/chart_template_guide/#debugging-templates).\n","type":"Details"},{"order":"03-02-bind-bundles","title":"Bind bundles","source":"\nIf you defined in the `meta.yaml` file that your plan is bindable, you must also create a `bind.yaml` file.\nThe `bind.yaml` file supports the Service Catalog binding concept. It is mandatory for all bindable plans as it contains information needed during the binding process. Currently, Kyma supports only the [credentials-type binding](https://github.com/openservicebrokerapi/servicebroker/blob/v2.13/spec.md#types-of-binding).   \n\n>**NOTE:** Resolving the values from the `bind.yaml` file is a post-provision action. If this operation ends with an error, the provisioning also fails.\n\nIn the `bind.yaml` file, you can use the Helm chart templates directives. See the example:\n\n```yaml\n# bind.yaml\ncredential:\n  - name: HOST\n    value: {{ template \"redis.fullname\" . }}.{{ .Release.Namespace }}.svc.cluster.local\n{{- if .Values.usePassword }}\n  - name: REDIS_PASSWORD\n    valueFrom:\n      secretKeyRef:\n        name: {{ template \"redis.fullname\" . }}\n        key: redis-password\n{{- end }}\n```\nIn this example, the system renders the `bind.yaml` file. The system resolves all the directives enclosed in the double curly braces in the same way as in the files located in the `templates` directory in your Helm chart.\n\n\n### File specification\n\nDefine the following fields to create a valid `bind.yaml` file:\n\n|   Field Name   |      Description                       |\n|--------------|--------------------------------------------------------------|\n| **credential** | The list of credential variables returned during the binding action.  |\n| **credential.name** | The name of a given credential variable.  |\n| **credential.value** | The variable value. You can also use the Helm Chart templating directives. This field is interchangeable with **credential.valueFrom**. |\n| **credential.valueFrom** | The source of the given credential variable's value. This field is interchangeable with **credential.value**.  |\n| **credential.valueFrom.configMapKeyRef** | The field which selects a ConfigMap key in the Helm chart release Namespace.    |\n| **credential.valueFrom.configMapKeyRef.name** | The name of the ConfigMap.  |\n| **credential.valueFrom.configMapKeyRef.key**  | The name of the key from which the value is retrieved.  |\n| **credential.valueFrom.secretKeyRef**  | The field which selects a Secret key in the Helm Chart release Namespace.     |\n| **credential.valueFrom.secretKeyRef.name**    | The name of the Secret.     |\n| **credential.valueFrom.secretKeyRef.key**    | The name of the key from which the value is retrieved. |\n| **credential.valueFrom.serviceRef**   | The field which selects a service resource in the Helm Chart release Namespace. |\n| **credential.valueFrom.serviceRef.name**    | The name of the service.          |\n| **credential.valueFrom.serviceRef.jsonpath**  | The JSONPath expression used to select the specified field value. For more information, see the [User Guide](https://kubernetes.io/docs/user-guide/jsonpath/). |\n| **credentialFrom** | The list of sources to populate credential variables on the binding action. When the key exists in multiple sources, the value associated with the last source takes precedence. Variables from the `credential` section override the values if duplicated keys exist. |\n| **credentialFrom.configMapRef** | The ConfigMap to retrieve the values from. It must be available in the Helm chart release Namespace. |\n| **credentialFrom.configMapRef.name**    | The name of the ConfigMap.   |\n| **credentialFrom.secretRef** | The Secret to retrieve the values from. It must be available in the Helm chart release Namespace.  |\n| **credentialFrom.secretRef.name**    | The name of the Secret.      |\n\n\nSee the fully extended example of the `bind.yaml` file:\n\n```yaml\ncredential:\n  - name: HOST\n    value: redis.svc.cluster.local\n  - name: PORT\n    valueFrom:\n      serviceRef:\n        name: redis-svc\n        jsonpath: '{ .spec.ports[?(@.name==\"redis\")].port }'\n  - name: REDIS_PASSWORD\n    valueFrom:\n      secretKeyRef:\n        name: redis-secrets\n        key: redis-password\n  - name: REDIS_DB_NAME\n    valueFrom:\n      configMapKeyRef:\n        name: redis-cm\n        key: redis-db-name\n\ncredentialFrom:\n  - configMapRef:\n    name: redis-config\n  - secretRef:\n    name: redis-v2-secrets\n```\n\nIn this example, the Helm Broker returns the following values:\n- A `HOST` key with the defined inlined value.\n- A `PORT` key with the value from the field specified by the JSONPath expressions. The `redis-svc` Service runs this expression.\n- A `REDIS_PASSWORD` key with a value selected by the `redis-password` key from the `redis-secrets` Secret.\n- All the key-value pairs fetched from the `redis-config` ConfigMap.\n- All the key-value pairs fetched from the `redis-v2-secrets` Secrets.\n\n\n### Credential name conflicts policy\n\nThe following rules apply in case of credential name conflicts:\n- If the **credential** and **credentialFrom** fields have duplicate values, the system uses the values from the **credential** field.\n- If you duplicate a key in the **credential** field, an error appears and informs you about the name of the key that the conflict refers to.\n- If a key exists in the multiple sources defined by the **credentialFrom** section, the value associated with the last source takes precedence.\n","type":"Details"},{"order":"03-03-create-bundles-repo","title":"Create a bundles repository","source":"\nThe repository in which you create your own bundles must be an HTTPS server with a specific structure so that the Helm Broker can fetch bundles from it. Your remote bundle repository can contain many bundles, each one compressed to the `.tgz` format and defined in `index.yaml` files. Depending on your needs and preferences, you can create one or more `index.yaml` files to categorize your bundles. The repository structure looks as follows:\n\n```\nsample-bundle-repository\n  ├── {bundle_x_name}-{bundle_x_version}.tgz         # A bundle compressed to a .tgz file\n  ├── {bundle_y_name}-{bundle_y_version}.tgz        \n  ├── ...                                      \n  ├── index.yaml                                     # A file which defines available bundles\n  ├── index-2.yaml                              \n  └── ...                                                    \n```\n\nRead [this](https://github.com/kyma-project/bundles/blob/master/docs/getting-started.md) document to learn how to set up your own bundles repository which generates `.tgz` and `index.yaml` files, and expose them using an HTTPS server. See the example of the Kyma `bundles` repository [here](https://github.com/kyma-project/bundles/releases).\n\n### {bundle_name}-{bundle_version}.tgz file\n\nThe `{bundle_name}-{bundle_version}.tgz` file is a compressed version of your bundle. To learn how to create your own bundle, read [this](#details-create-a-bundle) document.\n\n>**TIP:** If you contribute to the [bundles](https://github.com/kyma-project/bundles/tree/master/bundles) repository, you do not have to compress your bundles as the system does it automatically.\n\n### index.yaml file\n\nIn the `index.yaml` file, provide an entry for every single bundle from your bundles repository. The `index.yaml` file must have the following structure:\n\n```\napiVersion: v1\nentries:\n  {bundle_name}:\n    - name: {bundle_name}\n      description: {bundle_description}\n      version: {bundle_version}\n```\n\nSee the example:\n\n```yaml\napiVersion: v1\nentries:\n  redis:\n    - name: redis\n      description: Redis service\n      version: 0.0.1\n```\n","type":"Details"},{"order":"05-04-configure-hb","title":"Configuration","source":"\nBy default, the Helm Broker fetches bundles listed in the `index.yaml` file from the `bundles` repository [release](https://github.com/kyma-project/bundles/releases). You can also configure the Helm Broker to fetch bundle definitions from other remote HTTPS servers. To do so, follow these steps:\n\n1. [Create a repository](#details-create-a-bundles-repository) with your bundles. To complete this tutorial step by step, use the existing [bundles](https://github.com/kyma-project/bundles/tree/master/bundles) repository.\n2. [Install Kyma](/docs/latest/root/kyma/#installation-installation) locally or on a cluster.\n3. Create a ConfigMap which contains an URL to the repository. You can either:\n\n  * Create a ConfigMap using the `kubectl create` command:\n\n    ```bash\n    kubectl create configmap my-helm-repos-urls -n kyma-system --from-literal=URLs=https://github.com/kyma-project/bundles/releases/download/0.3.0/index-testing.yaml\n    ```\n    >**NOTE:** If you want to fetch bundles from many HTTP servers, use `\\n` to separate the URLs.\n    \n    If you use this method, you must label your ConfigMap with `helm-broker-repo=true`. To add the label to your ConfigMap, run:\n    ```bash\n    kubectl label configmap my-helm-repos-urls -n kyma-system helm-broker-repo=true\n    ```\n\n  * Create a valid ConfigMap from the `yaml` file. Follow this example:\n\n    ```yaml\n    apiVersion: v1\n    kind: ConfigMap\n    metadata:\n      name: my-helm-repos-urls\n      labels:\n        helm-broker-repo: \"true\"\n        data:\n          URLs: |-\n            https://github.com/kyma-project/bundles/releases/download/0.3.0/index-testing.yaml\n    ```\n\n    Then, run:\n    ```bash\n    kubectl apply my-helm-repos-urls\n    ```\n    >**NOTE:** Your bundle repository must contain at least one file named `index.yaml` as the Helm Broker automatically searches for it when you provide the `https://{host}/{path}/{bundle_repo_version}/` URL to your ConfigMap.\n\n  The default ConfigMap provided by the Helm Broker is the [`helm-repos-urls`](https://github.com/kyma-project/kyma/blob/master/resources/helm-broker/templates/cfg-repos-url.yaml) ConfigMap. Do not edit this ConfigMap. Create a separate one instead. Depending on your needs and preferences, you can create one or more ConfigMaps with URLs to different remote HTTPS servers.\n\n4. The Helm Broker triggers the Service Catalog synchronization automatically. New Service Classes appear after a few seconds.\n\n## Configuration rules\n\nThese are the rules you must follow when you configure the Helm Broker. Otherwise, the Helm Broker will not display your bundles.\n* If you use your bundle in two different repositories simultaneously, the Helm Broker detects a conflict and does not display this bundle at all. You can see the details of the conflict in the Helm Broker application logs. If you need a given bundle in two or more repositories, do not use them at the same time.\n* On your non-local clusters, you can use only servers with TLS enabled. All incorrect or unsecured URLs will be omitted. Find the information about the rejected URLs in the Helm Broker logs. You can use unsecured URLs only on your local cluster. To use URLs without TLS enabled, set the **config.isDevelopMode** environment variable in the [values.yaml](https://github.com/kyma-project/kyma/blob/master/resources/helm-broker/values.yaml) file to `true`.\n"}]},"navigation":{"root":[{"displayName":"Kyma","id":"kyma"}],"components":[{"displayName":"Security","id":"security"},{"displayName":"Service Catalog","id":"service-catalog"},{"displayName":"Helm Broker","id":"helm-broker"},{"displayName":"Application Connector","id":"application-connector"},{"displayName":"Event Bus","id":"event-bus"},{"displayName":"Service Mesh","id":"service-mesh"},{"displayName":"Serverless","id":"serverless"},{"displayName":"Monitoring","id":"monitoring"},{"displayName":"Tracing","id":"tracing"},{"displayName":"API Gateway","id":"api-gateway"},{"displayName":"Logging","id":"logging"},{"displayName":"Backup","id":"backup"},{"displayName":"Console","id":"console"},{"displayName":"Asset Store","id":"asset-store"},{"displayName":"Headless CMS","id":"headless-cms"}]},"manifest":{"root":[{"displayName":"Kyma","id":"kyma"}],"components":[{"displayName":"Security","id":"security"},{"displayName":"Service Catalog","id":"service-catalog"},{"displayName":"Helm Broker","id":"helm-broker"},{"displayName":"Application Connector","id":"application-connector"},{"displayName":"Event Bus","id":"event-bus"},{"displayName":"Service Mesh","id":"service-mesh"},{"displayName":"Serverless","id":"serverless"},{"displayName":"Monitoring","id":"monitoring"},{"displayName":"Tracing","id":"tracing"},{"displayName":"API Gateway","id":"api-gateway"},{"displayName":"Logging","id":"logging"},{"displayName":"Backup","id":"backup"},{"displayName":"Console","id":"console"},{"displayName":"Asset Store","id":"asset-store"},{"displayName":"Headless CMS","id":"headless-cms"}]},"assetsPath":"/assets/docs/0.9/helm-broker/docs/assets/","docsType":"components","topic":"helm-broker","slidesBanner":{"bannerDuration":5000,"slides":[{"text":"Don't miss the session by Piotr Kopczynski at Helm Summit on September 11 at 15:47.","url":"https://helmsummit2019.sched.com/event/S8sS","startDate":"09/09/2019","endDate":"12/09/2019"}]},"locale":"en"}}}